name: YouTube Shorts & Longform Auto Upload

on:
  schedule:
    # ‚è∞ ÏãúÍ∞ÑÎåÄ Î≥ÄÌôò: KST - 9ÏãúÍ∞Ñ = UTC
    # üé¨ ÏáºÏ∏†: Îß§Ïùº 3Ìöå / Î°±Ìèº: Îß§Ïùº 2Ìöå (11:30 KSTÎßå Ï†úÏô∏)
    - cron: '30 2 * * *'     # Îß§Ïùº 02:30 UTC = 11:30 KST (ÏáºÏ∏†Îßå)
    - cron: '30 8 * * *'     # Îß§Ïùº 08:30 UTC = 17:30 KST (ÏáºÏ∏† + Î°±Ìèº)
    - cron: '30 12 * * *'    # Îß§Ïùº 12:30 UTC = 21:30 KST (ÏáºÏ∏† + Î°±Ìèº)
  
  workflow_dispatch:  # ÏàòÎèô Ïã§Ìñâ Í∞ÄÎä•
    inputs:
      type:
        description: 'Video type to generate'
        required: true
        default: 'shorts'
        type: choice
        options:
          - 'shorts'
          - 'longform'
          - 'both'
      count:
        description: 'Number of videos to generate (shorts only)'
        required: false
        default: '1'
        type: choice
        options:
          - '1'
          - '2'
          - '3'
      upload:
        description: 'Enable YouTube upload'
        required: true
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

env:
  UPLOAD_ENABLED: ${{ github.event.inputs.upload || 'true' }}
  VIDEO_COUNT: ${{ github.event.inputs.count || '1' }}
  VIDEO_TYPE: ${{ github.event.inputs.type || 'shorts' }}

jobs:
  create-and-upload:
    runs-on: ubuntu-latest
    
    steps:
      - name: Determine video type
        id: set-type
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # ÏàòÎèô Ïã§Ìñâ: ÏÇ¨Ïö©Ïûê ÏÑ†ÌÉùÍ∞í ÏÇ¨Ïö©
            echo "VIDEO_TYPE=${{ github.event.inputs.type }}" >> $GITHUB_ENV
          elif [ "${{ github.event.schedule }}" = "30 2 * * *" ]; then
            # 11:30 KST: ÏáºÏ∏†Îßå
            echo "VIDEO_TYPE=shorts" >> $GITHUB_ENV
          else
            # 17:30, 21:30 KST: ÏáºÏ∏† + Î°±Ìèº
            echo "VIDEO_TYPE=both" >> $GITHUB_ENV
          fi

      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install FFmpeg and Korean fonts
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg
          
          # Noto Sans CJK Ìè∞Ìä∏ (Í∂åÏû•)
          sudo apt-get install -y fonts-noto-cjk fonts-noto-cjk-extra
          
          # Nanum Ìè∞Ìä∏ (ÎåÄÏ≤¥Ïö©)
          sudo apt-get install -y fonts-nanum fonts-nanum-coding
          
          # Ìè∞Ìä∏ Ï∫êÏãú ÏóÖÎç∞Ïù¥Ìä∏
          sudo fc-cache -fv
          
          # ÏÑ§ÏπòÎêú ÌïúÍ∏Ä Ìè∞Ìä∏ ÌôïÏù∏
          echo "=== ÏÑ§ÏπòÎêú ÌïúÍ∏Ä Ìè∞Ìä∏ ==="
          fc-list | grep -i "noto\|nanum" || echo "No fonts found"
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Setup credentials
        run: |
          mkdir -p config
          
          # YouTube OAuth Ïù∏Ï¶ù ÌååÏùº ÏÉùÏÑ± (GitHub SecretsÏóêÏÑú)
          echo '${{ secrets.YOUTUBE_CLIENT_SECRETS }}' > config/client_secrets.json
          
          # Ï±ÑÎÑê IDÏóê ÎßûÎäî Ïù∏Ï¶ù ÌååÏùºÎ™Ö ÏÉùÏÑ± (YouTubeUploaderÏùò ÎÑ§Ïù¥Î∞ç Í∑úÏπô ÏùºÏπò)
          echo '${{ secrets.YOUTUBE_CREDENTIALS }}' > config/youtube_credentials.json
          echo '${{ secrets.YOUTUBE_CREDENTIALS }}' > config/youtube_credentials_L4y1Qbdg.json
          
          # config.jsonÏóê API ÌÇ§ Ï£ºÏûÖ (Secrets ‚Üí config.json)
          python -c "
          import json
          with open('config/config.json', 'r') as f:
              config = json.load(f)
          config['gemini_api_key'] = '${{ secrets.GEMINI_API_KEY }}'
          config['huggingface_token'] = '${{ secrets.HUGGINGFACE_TOKEN }}'
          config['together_api_key'] = '${{ secrets.TOGETHER_API_KEY }}'
          config['pexels_api_key'] = '${{ secrets.PEXELS_API_KEY }}'
          config['scheduler']['upload_enabled'] = ('${{ env.UPLOAD_ENABLED }}' == 'true')
          with open('config/config.json', 'w') as f:
              json.dump(config, f, indent=2, ensure_ascii=False)
          "
      
      - name: Create video
        run: |
          if [ "${{ env.UPLOAD_ENABLED }}" = "true" ]; then
            python main.py --type ${{ env.VIDEO_TYPE }} --count ${{ env.VIDEO_COUNT }}
          else
            python main.py --type ${{ env.VIDEO_TYPE }} --count ${{ env.VIDEO_COUNT }} --no-upload
          fi
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: generated-video-${{ github.run_number }}
          path: |
            output/videos/*.mp4
            output/longform_videos/*.mp4
            output/thumbnails/*.jpg
            output/images/*.png
            output/longform_images/*.jpg
            logs/*.json
          retention-days: 7
