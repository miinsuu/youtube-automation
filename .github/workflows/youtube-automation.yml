name: YouTube Shorts & Longform Auto Upload

on:
  schedule:
    # ⏰ GitHub Actions cron은 :00(정시)에 지연이 심함 → :23 오프셋 사용
    # 버퍼를 충분히 확보하여 GitHub 지연(최대 2-3시간) 흡수
    # 타겟: 12:00 KST (03:00 UTC), 18:00 KST (09:00 UTC), 22:00 KST (13:00 UTC)
    - cron: '23 22 * * *'    # 22:23 UTC (07:23 KST) 실행 → 12:00 KST 공개 (쇼츠만, ~5시간 버퍼)
    - cron: '23 3 * * *'     # 03:23 UTC (12:23 KST) 실행 → 18:00 KST 공개 (쇼츠 + 롱폼, ~6시간 버퍼)
    - cron: '23 7 * * *'     # 07:23 UTC (16:23 KST) 실행 → 22:00 KST 공개 (쇼츠 + 롱폼, ~6시간 버퍼)
  
  workflow_dispatch:  # 수동 실행 가능
    inputs:
      type:
        description: 'Video type to generate'
        required: true
        default: 'shorts'
        type: choice
        options:
          - 'shorts'
          - 'longform'
          - 'both'
      count:
        description: 'Number of videos to generate (shorts only)'
        required: false
        default: '1'
        type: choice
        options:
          - '1'
          - '2'
          - '3'
      upload:
        description: 'Enable YouTube upload'
        required: true
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

env:
  UPLOAD_ENABLED: ${{ github.event.inputs.upload || 'true' }}
  VIDEO_COUNT: ${{ github.event.inputs.count || '1' }}
  VIDEO_TYPE: ${{ github.event.inputs.type || 'shorts' }}

jobs:
  create-and-upload:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Determine video type and publish time
        id: set-type
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # 수동 실행: 사용자 선택값 사용 (즉시 공개)
            echo "VIDEO_TYPE=${{ github.event.inputs.type }}" >> $GITHUB_ENV
            echo "PUBLISH_AT=" >> $GITHUB_ENV
          elif [ "${{ github.event.schedule }}" = "23 22 * * *" ]; then
            # 타겟: 12:00 KST
            echo "VIDEO_TYPE=shorts" >> $GITHUB_ENV
            PUBLISH_AT=$(python3 -c "
          from datetime import datetime, timedelta, timezone
          kst = timezone(timedelta(hours=9))
          now = datetime.now(kst)
          target = now.replace(hour=12, minute=0, second=0, microsecond=0)
          if target <= now:
              print('')
          else:
              print(target.strftime('%Y-%m-%dT%H:%M:%S+09:00'))
          ")
            echo "PUBLISH_AT=$PUBLISH_AT" >> $GITHUB_ENV
          elif [ "${{ github.event.schedule }}" = "23 3 * * *" ]; then
            # 타겟: 18:00 KST
            echo "VIDEO_TYPE=both" >> $GITHUB_ENV
            PUBLISH_AT=$(python3 -c "
          from datetime import datetime, timedelta, timezone
          kst = timezone(timedelta(hours=9))
          now = datetime.now(kst)
          target = now.replace(hour=18, minute=0, second=0, microsecond=0)
          if target <= now:
              print('')
          else:
              print(target.strftime('%Y-%m-%dT%H:%M:%S+09:00'))
          ")
            echo "PUBLISH_AT=$PUBLISH_AT" >> $GITHUB_ENV
          elif [ "${{ github.event.schedule }}" = "23 7 * * *" ]; then
            # 타겟: 22:00 KST
            echo "VIDEO_TYPE=both" >> $GITHUB_ENV
            PUBLISH_AT=$(python3 -c "
          from datetime import datetime, timedelta, timezone
          kst = timezone(timedelta(hours=9))
          now = datetime.now(kst)
          target = now.replace(hour=22, minute=0, second=0, microsecond=0)
          if target <= now:
              print('')
          else:
              print(target.strftime('%Y-%m-%dT%H:%M:%S+09:00'))
          ")
            echo "PUBLISH_AT=$PUBLISH_AT" >> $GITHUB_ENV
          fi

      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install FFmpeg and Korean fonts
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg
          
          # Noto Sans CJK 폰트 (권장)
          sudo apt-get install -y fonts-noto-cjk fonts-noto-cjk-extra
          
          # Nanum 폰트 (대체용)
          sudo apt-get install -y fonts-nanum fonts-nanum-coding
          
          # 폰트 캐시 업데이트
          sudo fc-cache -fv
          
          # 설치된 한글 폰트 확인
          echo "=== 설치된 한글 폰트 ==="
          fc-list | grep -i "noto\|nanum" || echo "No fonts found"
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Setup credentials
        run: |
          mkdir -p config
          
          # YouTube OAuth 인증 파일 생성 (GitHub Secrets에서)
          echo '${{ secrets.YOUTUBE_CLIENT_SECRETS }}' > config/client_secrets.json
          
          # 채널 ID에 맞는 인증 파일명 생성 (YouTubeUploader의 네이밍 규칙 일치)
          echo '${{ secrets.YOUTUBE_CREDENTIALS }}' > config/youtube_credentials.json
          echo '${{ secrets.YOUTUBE_CREDENTIALS }}' > config/youtube_credentials_L4y1Qbdg.json
          
          # config.json에 API 키 주입 (Secrets → config.json)
          python -c "
          import json
          with open('config/config.json', 'r') as f:
              config = json.load(f)
          config['gemini_api_key'] = '${{ secrets.GEMINI_API_KEY }}'
          config['huggingface_token'] = '${{ secrets.HUGGINGFACE_TOKEN }}'
          config['together_api_key'] = '${{ secrets.TOGETHER_API_KEY }}'
          config['pexels_api_key'] = '${{ secrets.PEXELS_API_KEY }}'
          config['scheduler']['upload_enabled'] = ('${{ env.UPLOAD_ENABLED }}' == 'true')
          with open('config/config.json', 'w') as f:
              json.dump(config, f, indent=2, ensure_ascii=False)
          "
      
      - name: Validate YouTube credentials
        if: env.UPLOAD_ENABLED == 'true'
        run: |
          python3 -c "
          import sys
          sys.path.insert(0, 'scripts')
          from youtube_uploader import YouTubeUploader
          u = YouTubeUploader()
          if not u.authenticate():
              print('::error::YouTube 인증 실패 - YOUTUBE_CREDENTIALS Secret을 업데이트하세요')
              print('::error::로컬에서: python scripts/youtube_uploader.py  → config/youtube_credentials_L4y1Qbdg.json 내용을 GitHub Secret(YOUTUBE_CREDENTIALS)에 붙여넣기')
              sys.exit(1)
          ch = u.get_authenticated_channel()
          if ch:
              print(f'✅ 인증 확인: {ch[\"title\"]} ({ch[\"id\"]})')
          else:
              print('::error::채널 조회 실패 - 인증은 됐지만 채널 정보를 읽을 수 없습니다')
              sys.exit(1)
          "

      - name: Create video
        run: |
          PUBLISH_ARG=""
          if [ -n "${{ env.PUBLISH_AT }}" ]; then
            PUBLISH_ARG="--publish-at ${{ env.PUBLISH_AT }}"
          fi
          if [ "${{ env.UPLOAD_ENABLED }}" = "true" ]; then
            python main.py --type ${{ env.VIDEO_TYPE }} --count ${{ env.VIDEO_COUNT }} $PUBLISH_ARG
          else
            python main.py --type ${{ env.VIDEO_TYPE }} --count ${{ env.VIDEO_COUNT }} --no-upload
          fi
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: generated-video-${{ github.run_number }}
          path: |
            output/videos/*.mp4
            output/longform_videos/*.mp4
            output/thumbnails/*.jpg
            output/images/*.png
            output/longform_images/*.jpg
            logs/*.json
          retention-days: 7

      - name: Persist topic history to repo
        if: always()
        run: |
          if [ ! -f logs/topic_history.json ]; then
            echo "topic_history.json 없음 — 커밋 건너뜀"
            exit 0
          fi
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -f logs/topic_history.json
          git diff --staged --quiet && exit 0
          git commit -m "chore: update topic history [skip ci]"
          git stash --include-untracked
          git pull --rebase origin main || true
          git stash pop || true
          git push
